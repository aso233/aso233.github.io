<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>aso233 blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="aso233 blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="aso233 blog">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="aso233 blog">
  
    <link rel="alternative" href="/atom.xml" title="aso233 blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="null" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">aso233</a></h1>
		</hgroup>

		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>Menu</li>
						<li>Tags</li>
						
						<li>Links</li>
						
						
						<li>Über</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="#" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="#" title="weibo">weibo</a>
					        
								<a class="rss" target="_blank" href="#" title="rss">rss</a>
					        
								<a class="zhihu" target="_blank" href="#" title="zhihu">zhihu</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">奥巴马的博客</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">卡卡的美丽传说</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">本泽马的博客</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">吉格斯的博客</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">习大大大不同</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">托蒂的博客</a>
			        
			        </div>
				</section>
				

				
				
				<section class="switch-part switch-part4">
				
					<div id="js-aboutme">我是谁，我从哪里来，我到哪里去？我就是我，是颜色不一样的吃货…</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">aso233</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img lazy-src="null" class="js-avatar">
			
			</div>
			<hgroup>
			  <h1 class="header-author">aso233</h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="#" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="#" title="weibo">weibo</a>
			        
						<a class="rss" target="_blank" href="#" title="rss">rss</a>
			        
						<a class="zhihu" target="_blank" href="#" title="zhihu">zhihu</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap">
  
    <article id="post-CentOS 搭建android环境" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/06/12/CentOS 搭建android环境/" class="article-date">
  	<time datetime="2016-06-12T10:13:00.000Z" itemprop="datePublished">2016-06-12</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/06/12/CentOS 搭建android环境/">CentOS 搭建android环境</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="CentOS-搭建android环境"><a href="#CentOS-搭建android环境" class="headerlink" title="CentOS 搭建android环境"></a>CentOS 搭建android环境</h1><ol>
<li>安装JAVA环境<ul>
<li>下载jdk或者jre ：<br><a href="http://www.oracle.com/technetwork/java/javase/downloads/index.html" title="http://www.oracle.com/technetwork/java/javase/downloads/index.html" target="_blank" rel="external">http://www.oracle.com/technetwork/java/javase/downloads/index.html</a>    </li>
<li>配置环境变量<br>在/etc/profile中加入java路径，如：<br><code>export JAVA_HOME=/usr/local/soft/jdk1.6.0_14</code><br><code>export PATH=$JAVA_HOME/bin:$PATH</code><br><code>export CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar</code>  </li>
</ul>
</li>
</ol>
<ol>
<li><p>安装android SDK</p>
<ul>
<li>下载android SDK： <a href="https://developer.android.com/studio/index.html" title="https://developer.android.com/studio/index.html" target="_blank" rel="external">https://developer.android.com/studio/index.html</a> 并解压  </li>
<li>配置环境变量<br>在/etc/profile中加入android SDK解压路径，如：<br><code>export ANDROID_HOME=/usr/local/soft/android-sdk-linux</code><br><code>export PATH=$ANDROID_HOME/tools:$PATH</code></li>
<li>更新SDK<br><code>android list sdk -a</code> 列出当前所有SDK和工具版本列表<br><code>android update sdk -a -u -t 1,2,3</code> 选择更新列表中的某几项(list sdk -a列表的序号)，不加-t参数则表示全部更新</li>
</ul>
</li>
<li><p>安装ANT    </p>
<ul>
<li>下载ant包：<a href="http://ant.apache.org/bindownload.cgi" title="http://ant.apache.org/bindownload.cgi" target="_blank" rel="external">http://ant.apache.org/bindownload.cgi</a>，并解压  </li>
<li>配置环境变量<br>在/etc/profile中加入ant解压路径，如：<br><code>ANT_HOME=/usr/local/soft/apache-ant-1.9.7</code><br><code>PATH=$PATH:$ANT_HOME/bin</code>   </li>
</ul>
</li>
<li><p>ANT打包错误</p>
<ul>
<li><p>“Cannot run program “/usr/local/android-sdk-linux/build-tools/19.0.3/aapt”: error=2, No such file or director”<br>Android SDK里面提供的一些工具，比如adb、aapt、zipalign等， 都会依赖32-bit的库，如果系统是64-bit的话，也必须安装这些32-bit的库，如下：<br><code>sudo yum install -y glibc.i686 zlib.i686 libstdc++.i686</code>  </p>
</li>
<li><p>“/lib64/libc.so.6: version ‘GLIBC_2.14’ not found (required by /usr/local/soft/android-sdk-linux/build-tools/24.0.1/aapt)”<br>使用android最新build tool版本（目前为24.0.1）则要求系统glibc库为2.14。两种方案：一是指定android build tool的版本为较低的版本（如19.1）， 二是更新libc库，记录更新方法如下：  </p>
<p>  执行<code>strings /lib64/libc.so.6 | grep GLIBC</code>    查看系统libc版本：<br>GLIBC_2.2.5<br>GLIBC_2.2.6<br>GLIBC_2.3<br>GLIBC_2.3.2<br>GLIBC_2.3.3<br>GLIBC_2.3.4<br>GLIBC_2.4<br>GLIBC_2.5<br>GLIBC_2.6<br>GLIBC_2.7<br>GLIBC_2.8<br>GLIBC_2.9<br>GLIBC_2.10<br>GLIBC_2.11<br>GLIBC_2.12<br>GLIBC_PRIVATE<br>系统最高版本是2.12，但是android编译需要2.14，于是自己编译安装：<br><code>wget http://ftp.gnu.org/gnu/glibc/glibc-2.14.tar.gz</code><br><code>tar -zxvf glibc-2.14.tar.gz &amp;&amp; cd glibc-2.14 &amp;&amp; mkdir build &amp;&amp; cd build</code><br><code>../configure --prefix=/opt/glibc-2.14</code><br><code>make -j4</code><br><code>make install</code><br><code>cp -r /etc/ld.so.c* /opt/glibc-2.14/etc/</code><br><code>ln -sf /opt/glibc-2.14/lib/libc-2.14.so /lib64/libc.so.6</code><br><code>export LD_LIBRARY_PATH=/opt/glibc-2.14/lib:$LD_LIBRARY_PATH</code>  </p>
<p>  再次执行 <code>strings /lib64/libc.so.6 | grep GLIBC</code><br>GLIBC_2.2.5<br>GLIBC_2.2.6<br>GLIBC_2.3<br>GLIBC_2.3.2<br>GLIBC_2.3.3<br>GLIBC_2.3.4<br>GLIBC_2.4<br>GLIBC_2.5<br>GLIBC_2.6<br>GLIBC_2.7<br>GLIBC_2.8<br>GLIBC_2.9<br>GLIBC_2.10<br>GLIBC_2.11<br>GLIBC_2.12<br>GLIBC_2.13<br>GLIBC_2.14<br>GLIBC_PRIVATE<br>出现2.14说明更新成功。</p>
</li>
<li><p>Error:  Multilib version problems found. This often means that the root<br> cause is something else and multilib version checking is just<br> pointing out that there is a problem. Eg.:</p>
<ol>
<li><p>You have an upgrade for libstdc++ which is missing some<br>dependency that another package requires. Yum is trying to<br>solve this by installing an older version of libstdc++ of the<br>different architecture. If you exclude the bad architecture<br>yum will tell you what the root cause is (which package<br>requires what). You can try redoing the upgrade with<br>–exclude libstdc++.otherarch … this should give you an error<br>message showing the root cause of the problem.</p>
</li>
<li><p>You have multiple architectures of libstdc++ installed, but<br>yum can only see an upgrade for one of those arcitectures.<br>If you don’t want/need both architectures anymore then you<br>can remove the one with the missing update and everything<br>will work.</p>
</li>
<li><p>You have duplicate versions of libstdc++ installed already.<br>You can use “yum check” to get yum show these errors.</p>
<p>   …you can also use –setopt=protected_multilib=false to remove<br>this checking, however this is almost never the correct thing to<br>do as something else is very likely to go wrong (often causing<br>much more problems).</p>
<p>   Protected multilib versions: libstdc++-4.4.7-17.el6.i686 != libstdc++-4.4.7-16.el6.x86_64   </p>
<p>应该是库的版本不对吧，先更新一下64位的库，然后再安装：  </p>
<p><code>yum  update  libstdc++-4.4.7-16.el6.x86_64</code><br><code>yum install libstdc++.i686</code></p>
</li>
</ol>
</li>
</ul>
</li>
</ol>
<p>参考：<br><a href="https://linux.cn/article-5966-1.html" title="https://linux.cn/article-5966-1.html" target="_blank" rel="external">https://linux.cn/article-5966-1.html</a><br><a href="http://fpliu-blog.chinacloudsites.cn/it/os/android/sdk/installation/on-centos" title="http://fpliu-blog.chinacloudsites.cn/it/os/android/sdk/installation/on-centos" target="_blank" rel="external">http://fpliu-blog.chinacloudsites.cn/it/os/android/sdk/installation/on-centos</a><br><a href="http://www.cnblogs.com/qingchen1984/p/5757181.html" title="http://www.cnblogs.com/qingchen1984/p/5757181.html" target="_blank" rel="external">http://www.cnblogs.com/qingchen1984/p/5757181.html</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-AndfixTool" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/06/12/AndfixTool/" class="article-date">
  	<time datetime="2016-06-12T10:13:00.000Z" itemprop="datePublished">2016-06-12</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/06/12/AndfixTool/">AndfixTool</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="apktool"><a href="#apktool" class="headerlink" title="apktool"></a>apktool</h1><p>近期研究阿里的<a href="https://github.com/alibaba/AndFix" target="_blank" rel="external">Andfix</a>，这是一个可实现代码热修复功能的开源项目，使用其提供的apkpatch.jar生成新旧apk的差分包，然后将差分包放置指定位置进行加载，旧的包加载完成后可实现方法的替换，可用于紧急修复线上的bug。生成差分包的jar包代码并没有开源，所以我们的目的是弄清jar包的工作原理并自己实现编译出一个可用的jar包。  </p>
<p>使用jd-gui打开apkpatch-1.0.3.jar，jar包结构如下:<br><img src="http://i.imgur.com/x44V76U.png" alt=""><br>jar包包含的代码比较多，主要包括几个重点：  </p>
<ol>
<li>com.euler.patch ： 此包名下的代码是阿里自定义添加的代码，也是andfix的生成差分包的主要逻辑代码。  </li>
<li>org.jf.* ：此包名下其实是smali/baksmali的源代码，baksmali反编译apk，smali重新打包apk,dexlib2是核心，baksmali和smali都需要引用到dexlib2中的定义的方法和接口，util存放一些工具类。smali/baksmali源码地址：<a href="https://github.com/JesusFreke/smali" target="_blank" rel="external">https://github.com/JesusFreke/smali</a>  </li>
<li>brut.* ： 此包名下是我们常用的反编译工具apktool的源码，其实也是基于smali/baksmali的基础之上，封装了一些功能逻辑和参数校验等。apktool源码地址：<a href="https://github.com/iBotPeaches/Apktool" target="_blank" rel="external">https://github.com/iBotPeaches/Apktool</a>   </li>
</ol>
<p>经过一番挣扎，弄清楚jar包中各个包的来源之后，重点就是对apktool源码进行分析并在其基础上加入andfix的逻辑。  </p>
<p>下载apktool源码，导入android Studio：<br><img src="http://i.imgur.com/yNMTuim.png" alt=""></p>
<h2 id="编译Apktool源码"><a href="#编译Apktool源码" class="headerlink" title="编译Apktool源码"></a>编译Apktool源码</h2><p>apktool源码编译方法如下（<a href="http://ibotpeaches.github.io/Apktool/build/" target="_blank" rel="external">官方说明</a>）：</p>
<blockquote>
<p>gradlew.bat clean<br>gradlew.bat applyPatches<br>gradlew.bat build fatJar  </p>
</blockquote>
<p>其中，applyPatches其实是gradle插件的task：<a href="https://github.com/Minecrell/gitpatcher" target="_blank" rel="external">net.minecrell.gitpatcher</a>，工程的主build.bradle中引用了此插件:<br><img src="http://i.imgur.com/TUfZYMH.png" alt=""><br>此插件的作用是当执行applyPatches时：  </p>
<ol>
<li>updateSubmodules：检查submodule的git库状态是否处于最新状态，若不是则失败退出。目前发现执行之前必须将smali切换到master分支并且checkout到 *398630d才可update成功，应该是与apktool源码有关（源码依赖于398630d这个分支），还未做深入研究，后续可通过研究gitpatcher插件得到结论。  </li>
<li>applyPatches： 将patches目录下的patch文件一一打入submodule中并将最后生成的结果输出到target目录。我们看一下patches文件目录：<br><img src="http://i.imgur.com/1GNXJ3H.png" alt=""><br>这些patch就是apktool对于smali源码的修改内容，从patch的文件名可以大概猜出此patch做了什么修改，可以看出大部分的patch只是修改了smali目录下的各个目录的build.gradle，用于构造自己的项目结构。我们后面也可将andfix对于smali源码的修改以生成patch的形式放到此目录中。<br>需要注意的是git提供了两种简单的patch方案，一是用git diff生成的标准patch，二是git format-patch生成的Git专用Patch。专用patch包含比较详细的信息（可自行百度）：<br><img src="http://i.imgur.com/eIZ5fql.png" alt=""><br>经过实践发现在apktool中使用的是专用补丁，而标准补丁并不能用。专用补丁主要指令如下：  <blockquote>
<p>git ci -a -m “baksmali-andfix”<br>git format-patch -M master<br>git am D:/xxx.patch  </p>
</blockquote>
</li>
</ol>
<p>在执行gradlew.bat build fatjar中经常遇到执行test的时候出错导致编译失败，目前做法是之间将报错的测试代码注释。</p>
<h2 id="Apktool源码结构"><a href="#Apktool源码结构" class="headerlink" title="Apktool源码结构"></a>Apktool源码结构</h2><p>完成源码编译之后，我们可以看到目录下多了brut.apktool.smali目录，目录下就是经过patch之后的smali源码(如果感兴趣可用对比工具比较此目录和smali目录文件的区别便可看出patch修改的内容)。每次执行gradlew.bat clean之后，此目录就会被清除，下一次执行编译之前必须先执行gradlew.bat applyPatches：<br><img src="http://i.imgur.com/B5Uv75H.png" alt="">  </p>
<p>理解了applyPatches的作用之后再来看apktool源码的结构就很清晰了：  </p>
<ol>
<li>smali<br><img src="http://i.imgur.com/KMmwwtn.png" alt=""><br>此Module完全引用了smali的源码，从其git的远程仓库中便可看出：<br><img src="http://i.imgur.com/ZjU4RvV.png" alt="">  </li>
<li><p>brut.j.*<br><img src="http://i.imgur.com/VD1Hi6B.png" alt=""><br>此目录下主要是一些common、util类，服务于brut.apktool</p>
</li>
<li><p>brut.apktool<br><img src="http://i.imgur.com/R83LfBt.png" alt=""><br>查看apktool-lib的build.gradle可以看出其引用了其他的所有工程：<br><img src="http://i.imgur.com/xTd4o4X.png" alt=""><br>而apktool-cli只引用了apktool-lib,apktool-cli是最终的调用者，其只包含一个Main.java文件，实现的功能其实很简单，接收并过滤命令行的参数，调用引用库中方法。</p>
</li>
</ol>
<h2 id="加入andfix逻辑"><a href="#加入andfix逻辑" class="headerlink" title="加入andfix逻辑"></a>加入andfix逻辑</h2><p>了解了apktool的代码结构，现在我们要将andfix的代码加入，只需让其取代apktool-ci的位置。<br>修改settings.gradle:<br><img src="http://i.imgur.com/8tikWER.png" alt=""><br>加入andfix源码：<br><img src="http://i.imgur.com/rfbPkLm.png" alt=""><br>参照apktool-ci的build.gradle修改相应配置，主class类等：<br><img src="http://i.imgur.com/W7yTNEY.png" alt=""><br>刚加入代码时遇到一个问题：andfix引用了smali/dexlib2中的类，但是andfix又修改dexlib2的源码而且引用了andfix中的类，因此形成了一个circle dependences的问题，后来通过将dexlib2中引用到的andfix中的类移至dexlib2中解决了此问题，不知道阿里那边是如何编译的，暂时没想到更好的解决办法。<br><img src="http://i.imgur.com/g9fngSY.png" alt=""><br>andfix基本逻辑思路如下：  </p>
<p>1 实现关键类的equals方法  </p>
<ul>
<li>com.boyaa.patch.Main为入口类，接收命令输入的参数信息，过滤成功之后调用com.boyaa.patch.ApkPatch的doPatch方法，andfix的主要逻辑便是在此方法中。DexDiff.diff对比出两个apk中修改过的方法，buildCode将这些方法转换成smali文件，并重新打包成dex文件，build写入签名信息，release写入md5等校验信息。<br><img src="http://i.imgur.com/kzkg1Ht.png" alt="">  </li>
<li><p>org.jf.dexlib2.diff.DexDiffer类load两个apk的dex文件，严格按照<a href="https://source.android.com/devices/tech/dalvik/dex-format.html" title="dex文件格式" target="_blank" rel="external">dex文件的格式</a>将dex文件各个数据段的偏移地址读取到内存中，最终返回一个DexBackedDexFile对象，通过DexBackedDexFile.getClasses()获取到dex文件中所有方法，然后一一进行对比，将修改过或者新添加的方法加入DiffInfo中：<br><img src="http://i.imgur.com/3VCiXX2.png" alt="">  </p>
<p>  <img src="http://i.imgur.com/LYK2he3.png" alt=""></p>
</li>
<li>可以看到对比两个方法的不同时是通过getImplementation()进行对比，getImplementaion得到一个DexBackedMethodImplementation对象，而andfix做的一个重要处理就是给DexBackedMethodImplementation添加equals的实现 ：<br><img src="http://i.imgur.com/h7fc811.png" alt=""><br>getInstrctions()得到一个DexBackedInstruction对象，一样也为其实现equals方法：<br><img src="http://i.imgur.com/9e8ezFI.png" alt=""><br>而DexBackedInstruction又有许多子类，要为其所有的子类加上equals方法：<br><img src="http://i.imgur.com/jQKyZU3.png" alt=""></li>
</ul>
<p>2 为DiffInfo中的方法添加注解<br>从1中得到了修改过的方法集合之后将这些class转换成smali文件，andfix在写入smali文件之前为这些修改过的方法添加了注解，解析时判断如果有此注解便认为此方法需要更新。写入smali文件的方法在org.jf.baksmali.Adaptors.ClassDefinition的writeTo()中：  </p>
<p><img src="http://i.imgur.com/JJ26eQq.png" alt="">  </p>
<p>andfix在writeDirectMethods和writeVirtualMethods中都做了添加注解处理，MethodReplaceAnnotation便是自定义的注解类：</p>
<p><img src="http://i.imgur.com/QJyZqj1.png" alt="">  </p>
<p>而在org.jf.dexlib2.dexbacked.DexBackedMethod中需要添加这个额外的字段和方法：  </p>
<p><img src="http://i.imgur.com/uFxJmdO.png" alt=""><br><img src="http://i.imgur.com/PQ7JOAV.png" alt="">  </p>
<p>并且在get方法中将额外的annotion一并加入：<br><img src="http://i.imgur.com/0yz2mvO.png" alt="">  </p>
<p>3 添加_CF后缀<br>将andfix通过jar包生成的dex文件转换成jar包后查看可发现类名多了“_CF”后缀，主要通过TypeGenUtil实现。：<br><img src="http://i.imgur.com/Rj25yPg.png" alt=""><br>在jg-gui中全局搜索TypeGenUtil:<br><img src="http://i.imgur.com/nFGKcsL.png" alt=""><br>在每个地方都使用TypeGenUtil进行字符串替换即可。</p>
<p>目前将修改后的代码生成patch文件，放在gradle/smali-patches中:<br><img src="http://i.imgur.com/TbZpAC0.png" alt=""></p>
<p>0001-baksmali-method-access.patch : 修改了baksmali中的disassembleClass方法为</p>
<p>0002-dexlib2-addFiles.patch： 添加了andfix源码</p>
<p>0003-baksmali-dexlib2-inject-annotion.patch ： 添加注解</p>
<p>0004-dexlib2-add-equals-implements.patch：添加了equals方法实现</p>
<p>0005-baksmali-add-subffix-_CF.patch：添加CF后缀</p>
<p>0006-baksmali-cancel-some-test.patch： 注释部分报错测试代码</p>
<p>0007-dexlib2-add-instuction-equals.patch： 为DexBackedInstruction子类添加equals方法实现</p>
<p>参考：<a href="http://sunzeduo.blog.51cto.com/2758509/1540085" target="_blank" rel="external">http://sunzeduo.blog.51cto.com/2758509/1540085</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Git" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/06/12/Git/" class="article-date">
  	<time datetime="2016-06-12T10:13:00.000Z" itemprop="datePublished">2016-06-12</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/06/12/Git/">Git</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Git简介"><a href="#Git简介" class="headerlink" title="Git简介"></a>Git简介</h2><p>Git是目前最流行的分布式版本控制系统，它的由来却是偶然：<br>很多人都知道，Linus在1991年创建了开源的Linux，从此，Linux系统不断发展，已经成为最大的服务器系统软件了。<br>Linus虽然创建了Linux，但Linux的壮大是靠全世界热心的志愿者参与的，这么多人在世界各地为Linux编写代码，那Linux的代码是如何管理的呢？<br>事实是，在2002年以前，世界各地的志愿者把源代码文件通过diff的方式发给Linus，然后由Linus本人通过手工方式合并代码！<br>你也许会想，为什么Linus不把Linux代码放到版本控制系统里呢？不是有CVS、SVN这些免费的版本控制系统吗？因为Linus坚定地反对CVS和SVN，这些集中式的版本控制系统不但速度慢，而且必须联网才能使用。有一些商用的版本控制系统，虽然比CVS、SVN好用，但那是付费的，和Linux的开源精神不符。</p>
<p>不过，到了2002年，Linux系统已经发展了十年了，代码库之大让Linus很难继续通过手工方式管理了，社区的弟兄们也对这种方式表达了强烈不满，于是Linus选择了一个商业的版本控制系统BitKeeper，BitKeeper的东家BitMover公司出于人道主义精神，授权Linux社区免费使用这个版本控制系统。</p>
<p>安定团结的大好局面在2005年就被打破了，原因是Linux社区牛人聚集，不免沾染了一些梁山好汉的江湖习气。开发Samba的Andrew试图破解BitKeeper的协议（这么干的其实也不只他一个），被BitMover公司发现了（监控工作做得不错！），于是BitMover公司怒了，要收回Linux社区的免费使用权。</p>
<p>Linus可以向BitMover公司道个歉，保证以后严格管教弟兄们，嗯，这是不可能的。实际情况是这样的：<br>Linus花了两周时间自己用C写了一个分布式版本控制系统，这就是Git！一个月之内，Linux系统的源码已经由Git管理了！牛是怎么定义的呢？大家可以体会一下。<br>Git迅速成为最流行的分布式版本控制系统，尤其是2008年，GitHub网站上线了，它为开源项目免费提供Git存储，无数开源项目开始迁移至GitHub，包括jQuery，PHP，Ruby等等。  </p>
<h2 id="Git安装"><a href="#Git安装" class="headerlink" title="Git安装"></a>Git安装</h2><p>git下载地址：<a href="http://git-scm.com/download/" title="http://git-scm.com/download/" target="_blank" rel="external">http://git-scm.com/download/</a>, 目前最新版本为2.7.0<br>下载windows版本的安装包，安装完成之后，在右键菜单可以看到git的选项：  </p>
<pre><code>Git Init Here  (在当前目录初始化一个git仓库)  
Git Gui  (git图形界面)   
Git Bash  (git命令行窗口)  
</code></pre><p>点击Git Bash选项打开git命令行窗口，说明安装成功。<br>安装完成之后需要配置name和email</p>
<pre><code>git config --global user.name &quot;Your Name&quot;  
git config --global user.email &quot;email@example.com&quot;
</code></pre><p>注意：git config命令的–global参数，用了这个参数，表示你这台机器上所有的Git仓库都会使用这个配置，不加则表示只用于当前仓库。</p>
<h2 id="Git基本操作"><a href="#Git基本操作" class="headerlink" title="Git基本操作"></a>Git基本操作</h2><p><strong>1. 创建git仓库</strong></p>
<p>新建一个GitTest目录，在该目录下打开git命令行窗口输入：  </p>
<pre><code>git init  
git status  
</code></pre><p>git init执行之后，当前目录下将自动生成.git文件夹，保存仓库的版本信息和提交记录等。<br>git status 显示如下：<br><img src="http://i.imgur.com/jTgSGfs.png" alt=""><br>从输出信息可以看出当前仓库处于默认的master分支上，并且nothing to commit表示当前工作区是干净的，没有任何修改。</p>
<p><strong>2. 添加文件</strong><br>在目录中添加一个Test.txt文件，文件内容随意输入。  </p>
<pre><code>git status  
</code></pre><p><img src="http://i.imgur.com/O2oqxF1.png" alt="">  </p>
<p>红色表示该文件处于工作区，还未加入暂存区，可使用add命令将其加入：  </p>
<pre><code>git add Test.txt  
</code></pre><p><img src="http://i.imgur.com/9LU71bb.png" alt=""><br>绿色表示该文件已经加入暂存区，但还未提交到git仓库中。  </p>
<p><strong>3. 撤销修改</strong><br>使用checkout命令可撤销修改，工作区的内容还原到修改之前：  </p>
<pre><code>git checkout Test.txt  
</code></pre><p>reset HEAD可将暂存区中的内容还原至工作区：</p>
<pre><code>git reset HEAD
</code></pre><p>revert HEAD 生成一个新的提交来撤销某次提交  </p>
<pre><code>git revert HEAD
</code></pre><p><strong>4. 提交修改</strong><br>使用commit命令将暂存区中的内容提交到版本仓库中：  </p>
<pre><code>git commit -m &quot;first commit&quot;  // -m 后为提交的log信息
</code></pre><p>通过git log可查看仓库的提交信息：<br><img src="http://i.imgur.com/RQFEXwv.png" alt=""></p>
<p><strong>5. 创建分支</strong> </p>
<pre><code>git branch develop  
git branch -a   
</code></pre><p><img src="http://i.imgur.com/hnKK2Kw.png" alt=""></p>
<p>或者使用  </p>
<pre><code>git branch -b develop  
</code></pre><p>创建成功之后将自动切换到develop分支上  </p>
<p><strong>6. 切换分支</strong>  </p>
<pre><code>git checkout develop
</code></pre><p><img src="http://i.imgur.com/twIcpsU.png" alt=""><br>切换到另一个分支之前最好确认当前分支的工作区和暂存区是否干净，以免造成混淆。</p>
<h2 id="Git远程仓库操作"><a href="#Git远程仓库操作" class="headerlink" title="Git远程仓库操作"></a>Git远程仓库操作</h2><p><strong>1. 关联远程仓库</strong></p>
<pre><code>git remote add &lt;主机名&gt; &lt;网址&gt;  
git remote rm &lt;主机名&gt;  
git remote rename &lt;原主机名&gt; &lt;新主机名&gt;  
</code></pre><p><strong>2. git克隆</strong>  </p>
<p>支持多种协议： </p>
<pre><code>git clone &lt;版本库的网址&gt; &lt;本地目录名&gt;  

git clone http[s]://example.com/path/to/repo.git/  
git clone ssh://example.com/path/to/repo.git/  
git clone git://example.com/path/to/repo.git/  
git clone /opt/git/project.git   
git clone file:///opt/git/project.git  
git clone ftp[s]://example.com/path/to/repo.git/  
git clone rsync://example.com/path/to/repo.git/  
</code></pre><p><strong>2. 切换远程分支</strong></p>
<pre><code>git branch -a  
git checkout -b 本地分支名 远程主机名/远程分支名   
</code></pre><p>或者  </p>
<pre><code>git checkout -t 远程主机名/远程分支名 //默认会在本地建立一个和远程分支名字一样的分支
</code></pre><p><strong>3. 远程分支拉取</strong></p>
<ul>
<li><p>fetch：只拉取信息，并未进行merge  </p>
<pre><code>git fetch 
</code></pre><p>  将某个远程主机的更新，全部取回本地</p>
<pre><code>git fetch &lt;远程主机名&gt; &lt;分支名&gt;
</code></pre><p>  取回origin主机的master分支</p>
</li>
</ul>
<ul>
<li><p>pull：相当于做了fetch 和 merge</p>
<pre><code>git pull &lt;远程主机名&gt; &lt;远程分支名&gt;:&lt;本地分支名&gt;  
</code></pre></li>
</ul>
<p>如果远程分支是与当前分支合并，则冒号后面的部分可以省略。</p>
<p><strong>4. 远程分支推送</strong> </p>
<pre><code>git push &lt;远程主机名&gt; &lt;本地分支名&gt;:&lt;远程分支名&gt;   
</code></pre><p>如果省略远程分支名，则表示将本地分支推送与之存在”追踪关系”的远程分支（通常两者同名），如果该远程分支不存在，则会被新建。 </p>
<pre><code>git push --all origin 
</code></pre><p>将本地的所有分支都推送到远程主机，这时需要使用–all选项。</p>
<h2 id="git别名配置"><a href="#git别名配置" class="headerlink" title="git别名配置"></a>git别名配置</h2><p>为了便于输入，可以为git常用的命令配置别名，下面是一些常用的别名设置：</p>
<pre><code>git config --global alias.st status  
git config --global alias.co checkout  
git config --global alias.ci commit  
git config --global alias.br branch  
git config --global alias.lg &quot;log --color --graph --pretty=format:&apos;%Cred%h%Creset -%C(yellow)%d%Creset %s %Cgreen(%cr) %C(bold blue)&lt;%an&gt;%Creset&apos; --abbrev-commit&quot;
</code></pre><h2 id="在本地模拟远程仓库的创建和推送（工作目录为F-GitTest-）"><a href="#在本地模拟远程仓库的创建和推送（工作目录为F-GitTest-）" class="headerlink" title="在本地模拟远程仓库的创建和推送（工作目录为F:/GitTest/）"></a>在本地模拟远程仓库的创建和推送（工作目录为F:/GitTest/）</h2><p><strong>1. 创建远程仓库</strong>  </p>
<p>创建G_Server目录，在目录下打开Git Bash并执行创建仓库命令，创建仓库的方式有两种：</p>
<ul>
<li><p>裸仓库，只会生成一类文件用于记录版本库历史记录的.git目录下面的文件;而不会包含实际项目源文件的拷贝。</p>
<pre><code>git --bare init &lt;目录名&gt;
</code></pre></li>
<li><p>包含实际项目源文件的拷贝。       </p>
<pre><code>git init  
</code></pre></li>
</ul>
<p>如果你需要操作远程仓库的git库的话，应该使用git init，因为裸仓库只保存了git的历史提交和版本信息，并不允许进行git操作，会得到“This operation must be run in a work tree”错误提示。如果远程仓库不希望让人操作，则最好选择裸仓库。  </p>
<p><strong>2. 创建本地仓库1，提交内容到远程仓库</strong></p>
<ul>
<li><p>创建G_Client1目录，初始化仓库，添加测试文件Test.txt，并提交到本地    </p>
<pre><code>echo &quot;112233&quot;&gt;Test.txt  
git add Test.txt  
git ci -m “first commit from client1”  
</code></pre></li>
<li><p>关联远程仓库信息并推送到远程仓库:  </p>
</li>
</ul>
<p>远程仓库为裸仓库  </p>
<pre><code>git remote add origin file:///F:/GitTest/G_Server/目录名  
</code></pre><p>远程仓库非裸仓库：  </p>
<pre><code>git remote add origin file:///F:/GitTest/G_Server/.git
git push origin master  
</code></pre><p>如果远程仓库并不是以裸仓库的形式创建，且要推送的分支刚好是当前分支，则此推送可能会失败，:<br><img src="http://i.imgur.com/smHC7JE.png" alt=""><br>根据提示修改远程仓库 .git/config配置文件，加入：<br> [receive]<br>    denyCurrentBranch = ignore<br>重新提交即可成功。<br><strong>3. 创建本地仓库2，拉取远程仓库信息</strong>  </p>
<p>创建G_Client2目录，初始化仓库，关联远程仓库</p>
<pre><code>git init  
git remote add origin file:///F:/GitTest/G_Server/目录名  
git fetch origin  
git pull origin master  
</code></pre><p>拉取成功之后，目录下会生成远程仓库中的内容Test.txt，并且通过git log可查看提交记录。</p>
<p><strong>4. 本地仓库2推送修改内容到远程仓库，本地仓库1拉取更新信息</strong>  </p>
<ul>
<li><p>修改G_Client2目录下的Test.txt文件内容为“336699”，提交并推送</p>
<pre><code>echo &quot;336699&quot;&gt;Test.txt  
git add .  
git ci -m &quot;do some modification by client2&quot;      
git push origin master  
</code></pre></li>
<li><p>在G_Client1下拉取远程仓库更新信息，并进行更新  </p>
<pre><code>git fetch      
git pull origin master  
</code></pre></li>
</ul>
<p><img src="http://i.imgur.com/n7nk1y0.png" alt="">  </p>
<p>此时Test.txt文件已经修改，通过git log可查看提交记录：<br><img src="http://i.imgur.com/2spW0oj.png" alt="">  </p>
<p>通过本地模拟可基本了解远程仓库一些基本操作，也可将远程仓库放到网络服务器或者托管网站，如github中，将代码或者笔记随时提交到远程仓库，这样既安全也方便自己随时随地查看。</p>
<h1 id="2016-09-07补充"><a href="#2016-09-07补充" class="headerlink" title="2016.09.07补充"></a>2016.09.07补充</h1><h2 id="图形工具扩展"><a href="#图形工具扩展" class="headerlink" title="图形工具扩展"></a>图形工具扩展</h2><ul>
<li><p>配置git解决冲突图形工具（以beyond Compare4为例）<br>  配置Git安装目录下的/etc/gitconfig文件，追加或者修改如下：  </p>
<pre><code>[diff]  
    tool = bc4  
[difftool]  
    prompt = false  
[difftool &quot;bc4&quot;]  
    cmd = &quot;\&quot;D:/Program Files/Beyond Compare 4/BCompare.exe\&quot; \&quot;$LOCAL\&quot; \&quot;$REMOTE\&quot;&quot;  

[merge]  
    tool = bc4  
[mergetool]  
    prompt = false  
[mergetool &quot;bc4&quot;]  
    cmd = &quot;\&quot;D:/Program Files/Beyond Compare 4/BCompare.exe\&quot; \&quot;$PWD/$LOCAL\&quot; \&quot;$PWD/$REMOTE\&quot; \&quot;$PWD/$BASE\&quot; \&quot;$PWD/$MERGED\&quot;&quot;
    keepBackup = false
    trustExitCode = false  
</code></pre><p>  配置工具：  </p>
<pre><code>git config --global merge.tool bc4  
git config --global diff.tool bc4
</code></pre><p>  先执行git merge branch_name 当合并分支出现冲突时，执行</p>
<pre><code>git mergetool [filename]
</code></pre><p>  即可打开beyondCompare进行代码合并。<br>  （四个界面，LOCAL为本地分支修改内容，BASE为修改前的内容，REMOTE为要合并的分支修改的内容，MERGED为修改之后的最终内容）  </p>
<p>  同样也可用</p>
<pre><code>git difftool   
</code></pre><p>  调用beyondCompare查看修改内容  </p>
</li>
<li><p>sourceTree</p>
</li>
</ul>
<h1 id="2016-09-29补充"><a href="#2016-09-29补充" class="headerlink" title="2016.09.29补充"></a>2016.09.29补充</h1><h4 id="删除远程仓库的某次错误提交"><a href="#删除远程仓库的某次错误提交" class="headerlink" title="删除远程仓库的某次错误提交"></a>删除远程仓库的某次错误提交</h4><pre><code>git reset –mixed      此为默认方式，不带任何参数的git reset，就是这种方式，它回退到某个版本，只保留源码，回退commit和stage信息
git reset –soft     回退到某个版本， 只回退了commit的信息，不会恢复stage（如果还要提交，直接commit即可)
git reset –hard      彻底回退到某个版本， 本地的源码也会变为上一个版本的内容
</code></pre><p>方法一. 将本地版本reset到指定版本，然后 git push -f(force)到远程分支<br>方法二. 将本地reset到指定版本，删除远程分支，git push origin :master(删除前先备份), 重新提交  </p>
<h1 id="2016-10-08补充"><a href="#2016-10-08补充" class="headerlink" title="2016.10.08补充"></a>2016.10.08补充</h1><h4 id="git-删除已经-add-的文件"><a href="#git-删除已经-add-的文件" class="headerlink" title="git 删除已经 add 的文件"></a>git 删除已经 add 的文件</h4><p>使用 git rm 命令即可，有两种选择：<br>一种是 git rm –cached “文件路径”，不删除物理文件，仅将该文件从缓存中删除；<br>一种是 git rm –f “文件路径”，不仅将该文件从缓存中删除，还会将物理文件删除（不会回收到垃圾桶）。</p>
<h2 id="Git-常见问题记录"><a href="#Git-常见问题记录" class="headerlink" title="Git 常见问题记录"></a>Git 常见问题记录</h2><ol>
<li><p>git add 时提示 “Filename too long” 解决办法 </p>
<blockquote>
<p>git config –global core.longpaths true</p>
</blockquote>
</li>
<li><p>从ftp服务器克隆： git clone ssh://MartinLin@192.168.201.12:3600/home/MartinLin/repository/LocalPack  </p>
</li>
<li>从局域网克隆：git clone //BY-01-1146/LocalPack</li>
</ol>
<p>参考：<br><a href="http://www.liaoxuefeng.com/wiki/0013739516305929606dd18361248578c67b8067c8c017b000" title="http://www.liaoxuefeng.com/wiki/0013739516305929606dd18361248578c67b8067c8c017b000" target="_blank" rel="external">http://www.liaoxuefeng.com/wiki/0013739516305929606dd18361248578c67b8067c8c017b000</a><br><a href="http://www.ruanyifeng.com/blog/2014/06/git_remote.html" title="http://www.ruanyifeng.com/blog/2014/06/git_remote.html" target="_blank" rel="external">http://www.ruanyifeng.com/blog/2014/06/git_remote.html</a><br><a href="http://my.oschina.net/u/1010578/blog/348731" title="http://my.oschina.net/u/1010578/blog/348731" target="_blank" rel="external">http://my.oschina.net/u/1010578/blog/348731</a><br>beyondCompare下载地址：<a href="http://www.scootersoftware.com/download.php" title="http://www.scootersoftware.com/download.php" target="_blank" rel="external">http://www.scootersoftware.com/download.php</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-xutils" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/06/11/xutils/" class="article-date">
  	<time datetime="2016-06-11T10:13:00.000Z" itemprop="datePublished">2016-06-11</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/06/11/xutils/">xutils HttpUtils</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="xutils-HttpUtils"><a href="#xutils-HttpUtils" class="headerlink" title="xutils HttpUtils"></a>xutils HttpUtils</h1><p>近期由于项目需要开始研究学习xuitls框架，xutils是一款相当比较成熟的框架，主要模块涵盖了界面，数据库，网络以及图片缓存处理，已经基本能够满足一个app所需，此次重点学习其网络模块 HttpUtils。<br>github项目托管地址: <a href="https://github.com/wyouflf/xUtils.git" target="_blank" rel="external">https://github.com/wyouflf/xUtils.git</a></p>
<p>HttpUtils主要提供了以下几种接口：  </p>
<ol>
<li>configxxxxx： 配置参数信息，包括：返回结果字符编码，Http本地缓存大小、有效期等，超时时间。  </li>
<li>sendxxx：发送请求接口，包括常规的send和sendSync  </li>
<li>download：下载接口，重载了多种不同参数配置方法<br>xUtils网络通信方式使用了HttpClinet，在HttpUtils构造方法中便初始化了HttpClient，并初始化了部分参数。  </li>
</ol>
<p>此次我们重点分析xutils的下载接口，分析之前先要了解几个关键的java类：Callable, FutrueTask。  </p>
<p>Callable：类似Runnable接口，都可以被其他线程执行，Runnable声明方法为run(),Callable声明方法为call();Callable有返回值且可抛出异常，callable一般结合FutureTask进行使用。  </p>
<p>Future：提供访问任务执行结果的接口。<br><img src="http://i.imgur.com/3zTHmHy.png" alt=""><br>像之前使用Runnable开始执行任务之后，我们就无法获取任务执行的状态，也无法在任务完成后得到返回值，只能通过公共变量或者接口来实现。通过Futrue和Callable可以实现获取其他线程执行状态，任务执行完成后也可得到返回结果。从Java 1.5开始，就提供了Callable和Future，应该也是为了弥补Runnable的不足。</p>
<p>了解了上述两个关键的java类之后，我们来看看xUtils的下载接口实现：<br><img src="http://i.imgur.com/VD2dx4Y.png" alt=""><br>调用下载接口后，首先进行一些参数过滤之后创建了HttpRequest对象，封装保存请求参数信息，然后创建了HttpHandler对象，重点就是这个HttpHandler类。它继承了一个实现了Futrue接口的类PriorityAsyncTask<params, progress,="" result="">,在创建实例时便将httpClinet，charset等信息通过构造传递进去，然后设置了一些其他参数后调用了handher.executeExecutor()方法。<br><img src="http://i.imgur.com/Vg43hgO.png" alt=""><br>在executeOnExecutor方法中，我们看到了onPreExecute(),是不是很眼熟？没错，就是android异步处理任务AyncTask中的方法。实际上，xutils的http多线程框架是沿用了AyncTask的异步处理机制。下面我们跟着代码分析简单分析一下：<br>我们看到了mWoker,mFutrue两个变量，他们在构造方法中进行了初始化：<br><img src="http://i.imgur.com/NlGXtCG.png" alt=""><br><img src="http://i.imgur.com/Z8jl2mI.png" alt=""><br>mWoker实现了Callable接口，FutureTask实现了Futrue接口，他们结合在一起便是为了实现我们之前说过的获取其他线程执行状态的功能。在mWoker call()方法中，我们看到熟悉的doInBackground(),这里的mParams就是在executeOnExecutor开始时设置的params。<br>doInBackground()是抽象方法，我们在PriorityAsyncTask的子类HttpHandler中看到了其具体实现：<br><img src="http://i.imgur.com/prWdR2C.png" alt=""><br>我们看到了真正发送请求以及接受响应的地方。也看到另一个熟悉的方法publishProgress()<br><img src="http://i.imgur.com/9wMvyvK.png" alt=""><br><img src="http://i.imgur.com/uorSaPp.png" alt=""><br><img src="http://i.imgur.com/eEYsO9d.png" alt=""><br>可以发现，AsyncTask实际也是通过内部的一个Handler进行UI线程消息的处理，到此我们已经见到了AsyncTask大多数的方法了。  </params,></p>
<p>刚才说到了在构造中初始化了mWorker，mFuture两个对象，回到handher.executeExecutor()方法<br><img src="http://i.imgur.com/Vg43hgO.png" alt=""><br>我们看到调用了exec.execute()的方法，这个就是使用线程池来执行Futrue实例，exec是download方法传入<br>handler.executeOnExecutor(EXECUTOR, request, target, autoResume, autoRename)的EXECUTOR<br><img src="http://i.imgur.com/lNd0Nr6.png" alt=""><br><img src="http://i.imgur.com/l4Drb1x.png" alt=""><br>可以看出，xUtils内部使用了一个基于优先级的自定义线程池PriorityExecutor，拥有一个优先级缓存队列PriorityObjectBlockingQueue，可通过下载接口参数配置任务的优先级，当前使用的线程池最大容量为256，线程活跃队列为5个,等待时间1s。</p>
<p>通过对xutils下载模块的学习，深入理解了AsyncTask的工作原理，发现对JAVA并发线程许多东西不太了解，如果不理解其中几个关键的JAVA类，理解框架的内容就比较吃力，今后还需多看点这方面的资料。</p>
<p>参考：<br><a href="http://www.cnblogs.com/dolphin0520/p/3949310.html" target="_blank" rel="external">http://www.cnblogs.com/dolphin0520/p/3949310.html</a><br> <a href="http://blog.csdn.net/lmj623565791/article/details/38614699" target="_blank" rel="external">http://blog.csdn.net/lmj623565791/article/details/38614699</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-多线程下载总结" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/06/11/多线程下载总结/" class="article-date">
  	<time datetime="2016-06-11T06:13:00.000Z" itemprop="datePublished">2016-06-11</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/06/11/多线程下载总结/">多线程下载总结</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="多线程下载总结"><a href="#多线程下载总结" class="headerlink" title="多线程下载总结"></a>多线程下载总结</h1><h2 id="线程池的概念"><a href="#线程池的概念" class="headerlink" title="线程池的概念"></a>线程池的概念</h2><p>Java 5之后引入了Executor框架，使用了线程池机制，位于java.util.cocurrent包中。使用Executor框架可以更加方便简单地控制线程启动，执行和关闭，并且更加节约内存开销。</p>
<p>首先介绍一下Executor框架的几个重要类：  </p>
<ol>
<li><p>Executor<br>Executor接口中只定义了一个方法execute（Runnable command），该方法接收一个Runable实例，它用来执行一个任务，任务即一个实现了Runnable接口的类。</p>
</li>
<li><p>ExecutorService<br>ExecutorService接口继承自Executor接口，它提供了更丰富的实现多线程的方法，比如，ExecutorService提供了关闭自己的方法，以及可为跟踪一个或多个异步任务执行状况而生成 Future 的方法。 可以调用ExecutorService的shutdown（）方法来平滑地关闭 ExecutorService，调用该方法后，将导致ExecutorService停止接受任何新的任务且等待已经提交的任务执行完成(已经提交的任务会分两类：一类是已经在执行的，另一类是还没有开始执行的)，当所有已经提交的任务执行完毕后将会关闭ExecutorService</p>
</li>
<li><p>Executors<br>Executors提供了一系列工厂方法用于创先线程池，返回的线程池都实现了ExecutorService接口：<br><code>public static ExecutorService newFixedThreadPool(int nThreads)</code><br>创建固定数目线程的线程池。<br><code>public static ExecutorService newCachedThreadPool()</code><br>创建一个可缓存的线程池，调用execute将重用以前构造的线程（如果线程可用）。如果现有线程没有可用的，则创建一个新线程并添加到池中。终止并从缓存中移除那些已有 60 秒钟未被使用的线程。<br><code>public static ExecutorService newSingleThreadExecutor()</code><br>创建一个单线程化的Executor。<br><code>public static ScheduledExecutorService newScheduledThreadPool(int corePoolSize)</code><br>创建一个支持定时及周期性的任务执行的线程池，多数情况下可用来替代Timer类。</p>
</li>
<li><p>自定义线程池<br>通过ThreadPoolExecutor类，它有多个构造方法来创建线程池，用该类很容易实现自定义的线程池<br><code>public ThreadPoolExecutor (int corePoolSize, int maximumPoolSize, long keepAliveTime, TimeUnit  unit,BlockingQueue&lt;Runnable&gt; workQueue)， RejectedExecutionHandler handler</code>   </p>
<p> 根据实际情况合理地配置构造方法的参数才能获得效率最高，性能最好的线程池，几个重要参数如下：  </p>
<p> corePoolSize：线程池中所保存的核心线程数，包括空闲线程。  </p>
<p> maximumPoolSize：池中允许的最大线程数。  </p>
<p> keepAliveTime：线程池中的空闲线程所能持续的最长时间，当线程池中的线程数量大于corePoolSize时，这些多出的线程如果空闲时间超过持续时间keepAliveTime，则将会被销毁。  </p>
<p> unit：持续时间的单位，其参数为java.util.concurrent.TimeUnit中的几个静态属性，TimeUnit.SECONDS，TimeUnit.MINUTES等。  </p>
<p> workQueue：任务执行前保存任务的队列，仅保存由execute方法提交的Runnable任务。常见的几种队列类型如下：  </p>
<ul>
<li>SynchronousQueue  直接提交策略，  它将任务直接提交给线程而不保持它们。在此，如果不存在可用于立即运行任务的线程，则试图把任务加入队列将失败，因此会构造一个新的线程。此策略可以避免在处理可能具有内部依赖性的请求集时出现锁。直接提交通常要求无界 maximumPoolSizes 以避免拒绝新提交的任务。</li>
<li>LinkedBlockingQueue  无界队列，若其构造函数带一个规定大小的参数,生成的BlockingQueue有大小限制,若不带大小参数,所生成的BlockingQueue的大小由Integer.MAX_VALUE来决定.其所含的对象是以FIFO(先入先出)顺序排序的。使用无界队列（不具有预定义容量的LinkedBlockingQueue）将导致在所有 corePoolSize 线程都忙时新任务在队列中等待。这样，创建的线程就不会超过 corePoolSize，因此，maximumPoolSize 的值也就无效了。当每个任务完全独立于其他任务，即任务执行互不影响时，适合于使用无界队列</li>
<li>ArrayBlockingQueue 有界队列，有界队列有助于防止资源耗尽，但是可能较难调整和控制。队列大小和最大池大小可能需要相互折衷：使用大型队列和小型池可以最大限度地降低 CPU 使用率、操作系统资源和上下文切换开销，但是可能导致人工降低吞吐量。使用小型队列通常要求较大的池大小，CPU 使用率较高，但是可能遇到不可接受的调度开销，这样也会降低吞吐量。  </li>
<li><p>PriorityBlockingQueue 优先级队列，优先级队列类似于LinkedBlockQueue,同样可以在其构造函数中规定队列大小，但其所含对象的排序不是FIFO,而是依据对象的自然排序顺序或者是构造函数的Comparator决定的顺序。</p>
<p>handler： 线程池对拒绝任务的处理策略，常见的策略包括四种：  </p>
</li>
<li>在默认的 ThreadPoolExecutor.AbortPolicy 中，处理程序遭到拒绝将抛出运行时 RejectedExecutionException</li>
<li>在 ThreadPoolExecutor.CallerRunsPolicy 中，线程调用运行该任务的 execute 本身。此策略提供简单的反馈控制机制，能够减缓新任务的提交速度。</li>
<li>在 ThreadPoolExecutor.DiscardPolicy 中，不能执行的任务将被删除</li>
<li><p>在 ThreadPoolExecutor.DiscardOldestPolicy 中，如果执行程序尚未关闭，则位于工作队列头部的任务将被删除，然后重试执行程序（如果再次失败，则重复此过程）  </p>
<p>一个任务通过execute(Runnable)添加到线程池之后，线程池工作流程如下：</p>
</li>
<li>当线程池中的线程数量小于corePoolSize，即使此时线程池中的线程都处于空闲状态，也会创建新的线程来处理添加的任务。</li>
<li>当线程池中的线程数量大于等于corePoolSize,但是缓冲队列workQueue未满，那么任务将被放入缓冲队列中。</li>
<li>如果线程池中的线程数量大于corePoolSize,且缓冲队列已满，但是线程池中的线程数量小于maximumPoolSize，则此时会立即创建新的线程来处理被添加的任务。</li>
<li>如果线程池中的线程数量大于corePoolSize,缓冲队列已满，并且线程池中的线程数量等于maximumPoolSize，此时则通过handler所指定的策略来处理此任务。</li>
</ul>
</li>
</ol>
<h2 id="多线程下载的实现"><a href="#多线程下载的实现" class="headerlink" title="多线程下载的实现"></a>多线程下载的实现</h2><p>此多线程下载方案支持多任务，多线程同时下载。下载方式使用HttpURLConnection，线程池使用了PriorityBlockingQueue，支持通过设置优先级安排任务执行顺序，线程池corePoolSize默认为availableProcessors * 2，即可用处理器个数的两倍，maximumPoolSize默认为128，缓冲队列PriorityObjectBlockingQueue默认容量为10，也可根据实际情况自定义设置。大体流程如下：</p>
<ol>
<li>用户调用下载接口，传入下载配置参数  </li>
<li>简单条件过滤（关键是否为空判断）后，立即创建一线程并放入线程池中执行</li>
<li>该线程进行参数初始化之后，获取服务端文件信息，根据文件大小和下载线程数分配每个线程的下载量，并保存到数据库</li>
<li>开始下载，创建N个线程放入线程池中进行下载，实时返回下载进度，每条线程下载完成后判断是否所有线程都下载完成</li>
<li>返回下载结果，若都完成则返回成功，若有一个线程下载失败，则返回下载失败，停止其他线程的下载。</li>
</ol>
<p>此下载方案参考xUtils的线程池模型，结合对单任务使用多线程进行下载，若有不合理之处，请及时指出。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-hello-world" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/06/11/hello-world/" class="article-date">
  	<time datetime="2016-06-11T02:13:00.000Z" itemprop="datePublished">2016-06-11</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/06/11/hello-world/">Hello World</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Welcome to <a href="https://hexo.io/" target="_blank" rel="external">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="external">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="external">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="external">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo new <span class="string">"My New Post"</span></div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="external">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo server</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="external">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo generate</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="external">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo deploy</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="external">Deployment</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
  
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2017 aso233
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>